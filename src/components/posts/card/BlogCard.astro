---
import BannerImage from '@/components/base/BannerImage.astro'
import Link from '@/components/base/Link.astro'
import { Badge } from '@/components/ui/badge'
import { ICON_MAP, SITE } from '@/config'
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
} from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0

// 卡片尺寸配置 - 可自定义修改
const CARD_CONFIG = {
  // 卡片圆角
  rounded: 'rounded-lg',
  // 图片区域宽度（所有屏幕尺寸统一显示在左侧）
  imageWidth: 'max-w-[100px] sm:max-w-[140px]', // 移动端 100px，桌面端 140px
  // 内容区域内边距
  contentPadding: 'p-3',
  // 标题字体大小
  titleSize: 'text-lg',
  // 描述字体大小
  descriptionSize: 'text-xs',
  // 元信息字体大小
  metaSize: 'text-xs',
  // 元信息下边距
  metaMarginBottom: 'mb-4',
}
---

<div
  class:list={[
    'hover:bg-muted/50 overflow-hidden transition-all duration-300 ease-in-out',
    'hover:scale-[1.01] hover:shadow-lg',
    CARD_CONFIG.rounded,
  ]}
>
  <Link
    href={`/${entry.collection}/${entry.id}`}
    class="flex flex-row items-stretch"
  >
    <div
      class:list={[
        'shrink-0 self-stretch overflow-hidden',
        CARD_CONFIG.imageWidth,
      ]}
    >
      <BannerImage
        src={entry.data.image ?? undefined}
        defaultSrc={SITE.defaultPostBanner}
        alt={entry.data.title}
        width={1200}
        height={630}
        class="h-full w-full object-contain"
      />
    </div>

    <div class:list={['flex grow flex-col', CARD_CONFIG.contentPadding]}>
      <h3 class:list={['mb-1 font-bold', CARD_CONFIG.titleSize]}>
        {entry.data.title}
      </h3>
      <p
        class:list={[
          'text-muted-foreground mb-1.5',
          CARD_CONFIG.descriptionSize,
        ]}
      >
        {entry.data.description}
      </p>

      <p
        class:list={[
          'text-muted-foreground/60',
          CARD_CONFIG.metaSize,
          CARD_CONFIG.metaMarginBottom,
        ]}
      >
        <span>{formattedDate}</span> &nbsp;•&nbsp; {readTime}
        {
          subpostCount > 0 && (
            <>
              &nbsp;•&nbsp; {subpostCount}{' '}
              {subpostCount === 1 ? ' subpost' : ' subposts'}
            </>
          )
        }
      </p>

      {
        entry.data.tags && (
          <div class="flex flex-wrap gap-1.5">
            {entry.data.tags.map((tag: string) => {
              const iconEntry = ICON_MAP[tag as keyof typeof ICON_MAP]
              const iconName =
                (typeof iconEntry === 'string' ? iconEntry : iconEntry?.icon) ||
                'lucide:hash'
              const iconColor =
                typeof iconEntry === 'object' && iconEntry
                  ? iconEntry.color
                  : undefined
              return (
                <Badge
                  variant="muted"
                  className="flex bg-muted/30 border border-border items-center gap-x-1"
                >
                  <Icon
                    name={iconName}
                    class="size-2.5"
                    style={iconColor ? `color: ${iconColor}` : undefined}
                  />
                  {tag}
                </Badge>
              )
            })}
          </div>
        )
      }
    </div>
  </Link>
</div>
